

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Program Logic &mdash; Enotes CouchApp Tutorial v0.2 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Enotes CouchApp Tutorial v0.2 documentation" href="index.html" />
    <link rel="next" title="Extend our CouchApp" href="99-Expand.html" />
    <link rel="prev" title="Write the Interface" href="3-Interface.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="99-Expand.html" title="Extend our CouchApp"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="3-Interface.html" title="Write the Interface"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Enotes CouchApp Tutorial v0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="program-logic">
<h1>Program Logic<a class="headerlink" href="#program-logic" title="Permalink to this headline">¶</a></h1>
<p>We just have provided enought code to define a simple interface which does not do anything but display static words right now. To change this, we need to enter some JavaScript code.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>To give you an overview of the inner workings of our CouchApp and as a reference, you may refer to the following diagram. Dotted lines represent function calls and normal ones folder relations. Only folders relevant for us are represented, so if you miss e.g. the folders <tt class="docutils literal"><span class="pre">lists</span></tt>, <tt class="docutils literal"><span class="pre">shows</span></tt>, <tt class="docutils literal"><span class="pre">updates</span></tt> or <tt class="docutils literal"><span class="pre">vendor</span></tt> don&#8217;t wonder.</p>
<p class="graphviz">
<img src="_images/graphviz-5b8faf4b99150f50dde74e38995cdbe547353b00.png" alt="digraph {
    graph [size=&quot;12,9&quot;]
    graph [ranksep=0.00]
    graph [nodesep=0.00]
    // graph [ratio=4]
    graph [rankdir=TB]
    // graph [orientation=landscape]
    graph [ratio=auto]
    graph [labelloc=t]

    node [fontname=Verdana,fontsize=10]
    node [style=filled]
    node [fillcolor=&quot;#EEEEEE&quot;]
    node [color=&quot;#EEEEEE&quot;]
    edge [color=&quot;#555555&quot;]
    edge [fontsize=8]
    edge [arrowsize=0.5]
    edge [fontcolor=grey]

    &quot;enotes&quot; [shape=box]

    &quot;_attachments&quot; [color=&quot;grey&quot;]
    &quot;evently&quot; [color=&quot;grey&quot;]
    &quot;addPage&quot; [color=&quot;grey&quot;]
    &quot;_init&quot; [color=&quot;grey&quot;]
    &quot;selectors&quot; [color=&quot;grey&quot;]
    &quot;input&quot; [color=&quot;grey&quot;]
    &quot;editContent&quot; [color=&quot;grey&quot;]
    &quot;shownote &quot; [color=&quot;grey&quot;]
    &quot;_init &quot; [color=&quot;grey&quot;]
    &quot;selectors &quot; [color=&quot;grey&quot;]
    &quot;a[op=delete]&quot; [color=&quot;grey&quot;]
    &quot;a[op=save]&quot; [color=&quot;grey&quot;]
    &quot;editPage&quot; [color=&quot;grey&quot;]
    &quot;tagListPage&quot; [color=&quot;grey&quot;]
    &quot; selectors&quot; [color=&quot;grey&quot;]
    &quot; a &quot; [color=&quot;grey&quot;]
    &quot;tagListContent&quot; [color=&quot;grey&quot;]
    &quot;_init  &quot; [color=&quot;grey&quot;]
    &quot; selectors &quot; [color=&quot;grey&quot;]
    &quot;  a &quot; [color=&quot;grey&quot;]
    &quot;titleListPage&quot; [color=&quot;grey&quot;]
    &quot;titleListContent&quot; [color=&quot;grey&quot;]
    &quot;updateTitleList&quot; [color=&quot;grey&quot;]
    &quot;  selectors  &quot; [color=&quot;grey&quot;]
    &quot;  a  &quot; [color=&quot;grey&quot;]
    &quot;views&quot; [color=&quot;grey&quot;]
    &quot;DocbyTag&quot; [color=&quot;grey&quot;]
    &quot;DocbyTag2&quot; [color=&quot;grey&quot;]

            &quot;enotes&quot; -&gt; &quot;_attachments&quot;
                    &quot;_attachments&quot; -&gt; &quot;index.html&quot;
                    &quot;_attachments&quot; -&gt; &quot;logic.js&quot;

            &quot;enotes&quot; -&gt; &quot;evently&quot;
                    &quot;evently&quot; -&gt; &quot;addPage&quot;
                            &quot;addPage&quot; -&gt; &quot;pagebeforeshow.js&quot;
                            &quot;addPage&quot; -&gt; &quot;_init&quot;
                                    &quot;_init&quot; -&gt; &quot;selectors&quot;
                                            &quot;selectors&quot; -&gt; &quot;input&quot;
                                                    &quot;input&quot; -&gt; &quot;click.js&quot;

                    &quot;evently&quot; -&gt; &quot;editContent&quot;
                            &quot;editContent&quot; -&gt; &quot;shownote &quot;
                                    &quot;shownote &quot; -&gt; &quot;data.js&quot;
                                    &quot;shownote &quot; -&gt; &quot;async.js&quot;
                                    &quot;shownote &quot; -&gt; &quot;mustache.html&quot;
                                    &quot;shownote &quot; -&gt; &quot;after.js&quot;
                            &quot;editContent&quot; -&gt; &quot;_init &quot;
                                    &quot;_init &quot; -&gt; &quot;selectors &quot;
                                            &quot;selectors &quot; -&gt; &quot;a[op=delete]&quot;
                                                    &quot;a[op=delete]&quot; -&gt; &quot; click.js&quot;
                                            &quot;selectors &quot; -&gt; &quot;a[op=save]&quot;
                                                    &quot;a[op=save]&quot; -&gt; &quot;  click.js&quot;

                    &quot;evently&quot; -&gt; &quot;editPage&quot;
                            &quot;editPage&quot; -&gt; &quot; pagebeforeshow.js&quot;

                    &quot;evently&quot; -&gt; &quot;tagListPage&quot;
                            &quot;tagListPage&quot; -&gt; &quot;  pagebeforeshow.js&quot;
                            &quot;tagListPage&quot; -&gt; &quot; selectors&quot;
                                    &quot; selectors&quot; -&gt; &quot; a &quot;
                                            &quot; a &quot; -&gt; &quot; click .js&quot;

                    &quot;evently&quot; -&gt; &quot;tagListContent&quot;
                            &quot;tagListContent&quot; -&gt; &quot;_init  &quot;
                                    &quot;_init  &quot; -&gt; &quot; mustache.html&quot;
                                    &quot;_init  &quot; -&gt; &quot; after.js&quot;
                                    &quot;_init  &quot; -&gt; &quot; data.js&quot;
                                    &quot;_init  &quot; -&gt; &quot; query.json&quot;
                                    &quot;_init  &quot; -&gt; &quot; selectors &quot;
                                            &quot; selectors &quot; -&gt; &quot;  a &quot;
                                                    &quot;  a &quot; -&gt; &quot; click.js &quot;

                    &quot;evently&quot; -&gt; &quot;titleListPage&quot;
                            &quot;titleListPage&quot; -&gt; &quot; pagebeforeshow.js &quot;

                    &quot;evently&quot; -&gt; &quot;titleListContent&quot;
                            &quot;titleListContent&quot; -&gt; &quot;updateTitleList&quot;
                                    &quot;updateTitleList&quot; -&gt; &quot;  data.js  &quot;
                                    &quot;updateTitleList&quot; -&gt; &quot;  async.js  &quot;
                                    &quot;updateTitleList&quot; -&gt; &quot;  mustache.html  &quot;
                                    &quot;updateTitleList&quot; -&gt; &quot;  after.js  &quot;
                                    &quot;updateTitleList&quot; -&gt; &quot;  selectors  &quot;
                                            &quot;  selectors  &quot; -&gt; &quot;  a  &quot;
                                                    &quot;  a  &quot; -&gt; &quot;  click.js  &quot;

            &quot;enotes&quot; -&gt; &quot;views&quot;
                    &quot;views&quot; -&gt; &quot;DocbyTag&quot;
                            &quot;DocbyTag&quot; -&gt; &quot;map.js&quot;
                            &quot;DocbyTag&quot; -&gt; &quot;reduce.js&quot;
                    &quot;views&quot; -&gt; &quot;DocbyTag2&quot;
                            &quot;DocbyTag2&quot; -&gt; &quot;map.js &quot;



            &quot;index.html&quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;loads&quot;, constraint=false]
            // &quot;index.html&quot; -&gt; { &quot;addPage&quot;; &quot;editContent&quot;; &quot;editPage&quot;; &quot;tagListPage&quot;; &quot;tagListContent&quot;; &quot;titleListPage&quot;; &quot;titleListContent&quot;} [color=grey, label=&quot;links&quot;, concentrate=true]
            &quot;pagebeforeshow.js&quot; -&gt; &quot;shownote &quot; [color=grey, label=&quot;triggers&quot;]
            &quot;click.js&quot; -&gt; &quot;shownote &quot; [color=grey, label=&quot;triggers&quot;]
            &quot;click.js&quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;doStoreDocument()&quot;]
            &quot; pagebeforeshow.js &quot; -&gt; &quot;updateTitleList&quot; [color=grey, label=&quot;triggers&quot;]
            &quot;  async.js  &quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;doGetDoc()&quot;]
            &quot;  async.js  &quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;makeEmptyNote()&quot;]
            &quot;  pagebeforeshow.js&quot; -&gt; &quot;_init  &quot; [color=grey, label=&quot;triggers&quot;]
            // &quot; click.js &quot; -&gt; nur für REPLICATION
            &quot;  async.js  &quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;doView()&quot;]
            &quot; pagebeforeshow.js&quot; -&gt; &quot;shownote &quot; [color=grey, label=&quot;triggers&quot;]
            &quot;shownote &quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;doGetDoc()&quot;]
            &quot; click.js&quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;doDeleteDocument()&quot;]
            &quot;  click.js&quot; -&gt; &quot;logic.js&quot; [color=grey, label=&quot;doStoreDocument()&quot;]
            &quot;  click.js&quot; -&gt; &quot;shownote &quot; [color=grey, label=&quot;triggers&quot;]

    }" />
</p>
</div>
<div class="section" id="startup-code">
<h2>StartUp Code<a class="headerlink" href="#startup-code" title="Permalink to this headline">¶</a></h2>
<p>First, we need some code that initializes our application. We stay at our HTML file and add the following lines to the end of the file (but still within the <tt class="docutils literal"><span class="pre">&lt;html&gt;</span></tt>)</p>
<div class="highlight-html"><div class="highlight"><pre>    ...
    ...
    <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;vendor/couchapp/loader.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;logic.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>This code will execute two java scripts after loading the HTML page. One stored at <tt class="docutils literal"><span class="pre">vendor/couchapp/loader.js</span></tt> and the other one just called <tt class="docutils literal"><span class="pre">logic.js</span></tt>. Since we refer to these files, we will create them now.</p>
<div class="section" id="loader-js">
<h3>loader.js<a class="headerlink" href="#loader-js" title="Permalink to this headline">¶</a></h3>
<p>This file is located inside the <tt class="docutils literal"><span class="pre">vendor</span></tt> directory of our CouchApp tree. So, let&#8217;s navigate to this folder and enter the subfolder called <tt class="docutils literal"><span class="pre">couchapp</span></tt>. Here you see an additional directory called <tt class="docutils literal"><span class="pre">_attachments</span></tt>. This one holds all files which are attached to the design document of our CouchApp under the context of &#8220;vendor&#8221;. Its exactly the same as the default &#8220;_attachments&#8221; directory at our base with the difference that these files are uploaded within the &#8220;vendors&#8221; field.
We create the empty file <tt class="docutils literal"><span class="pre">loader.js</span></tt> at this location and open it with a text editor.</p>
<p>Enter the following function to the file:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">couchapp_load</span><span class="p">(</span><span class="nx">scripts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;script src=&quot;&#39;</span><span class="o">+</span><span class="nx">scripts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;&lt;\/script&gt;&#39;</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This function takes an array as argument (<tt class="docutils literal"><span class="pre">scripts</span></tt>) which holds a list of libraries. These libraries then are formatted to represent HTML calls and are injected into the HTML from where this function was called (in your case, into <tt class="docutils literal"><span class="pre">index.html</span></tt>). Thereby, these JavaScript libraries are loaded themselves.</p>
<p>But for the function to do anything it must not only be defined, but also be called. So, let&#8217;s call it. After the function definition, insert:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="p">...</span>
<span class="p">...</span>
<span class="nx">couchapp_load</span><span class="p">([</span>
    <span class="s2">&quot;/_utils/script/sha1.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/_utils/script/json2.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;/_utils/script/jquery.js&quot;</span><span class="p">,</span>

    <span class="s2">&quot;vendor/couchapp/jquery-1.6.2.min.js&quot;</span><span class="p">,</span>

    <span class="s2">&quot;vendor/couchapp/jquery.couch.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vendor/couchapp/jquery.couch.app.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vendor/couchapp/jquery.couch.app.util.js&quot;</span><span class="p">,</span>

    <span class="s2">&quot;vendor/couchapp/jquery.pathbinder.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vendor/couchapp/jquery.mustache.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vendor/couchapp/jquery.evently.js&quot;</span><span class="p">,</span>

    <span class="s2">&quot;vendor/couchapp/jquery-ui-1.8.11.custom.min.js&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vendor/couchapp/jquery.mobile-1.0.min.js&quot;</span>
<span class="p">]);</span>
</pre></div>
</div>
<p>This last code consists of the function call <tt class="docutils literal"><span class="pre">couchapp_load</span></tt> and an array of libraries to be loaded. So, when the file <tt class="docutils literal"><span class="pre">loader.js</span></tt> is opened from our HTML file, exactly this happens. The order in which these libraries are loaded is important since some of them depend on each other and cannot be loaded properly if the files they depend on have not already been loaded.</p>
<p>Let&#8217;s review these libraries and copy the ones still missing to <tt class="docutils literal"><span class="pre">vendor/couchapp/_attachments/</span></tt>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="39%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">file</th>
<th class="head">explanation</th>
<th class="head">where to get</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">/_utils/*.*</span></tt></td>
<td>They refer to files already available within CouchDB. Remember,
the path <tt class="docutils literal"><span class="pre">/_utils/</span></tt> points to the CouchDB user interface when
used within a web browser.</td>
<td>already present</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">jquery.couch.js</span></tt></td>
<td>Comes with every CouchDB installation and offers a JavaScript
interface for the CouchApp.</td>
<td>find it with a file search tool on your system</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">jquery-ui*.min.js</span></tt></td>
<td>The actual name of this file depends on the version of CouchDB
you have installed. You have to change the entry in <tt class="docutils literal"><span class="pre">loader.js</span></tt>
accordingly!</td>
<td>find it with a file search tool on your system</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">jquery-1.6.2.min.js</span></tt></td>
<td>This is the actual jQuery library.</td>
<td><a class="reference download internal" href="_downloads/jquery-1.6.2.min.js"><tt class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">a</span> <span class="pre">working</span> <span class="pre">copy</span> <span class="pre">here</span></tt></a>
or go to
<a class="reference external" href="http://docs.jquery.com/Downloading_jQuery">http://docs.jquery.com/Downloading_jQuery</a></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">jquery.mobile-1.0.min.js</span></tt></td>
<td>The mobile version of jQuery. A newer version than the one
proposed here may also work for you.</td>
<td><a class="reference download internal" href="_downloads/jquery.mobile-1.0.min.js"><tt class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">here</span></tt></a>
or find it at
<a class="reference external" href="http://jquerymobile.com/download/">http://jquerymobile.com/download/</a></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">jquery.pathbinder.js</span></tt></td>
<td>We need this file to use evently functions stored in the CouchApp
directory tree.</td>
<td><a class="reference download internal" href="_downloads/jquery.pathbinder.js"><tt class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">here</span></tt></a></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">jquery.evently.js</span></tt></td>
<td>Evently bindings</td>
<td><a class="reference download internal" href="_downloads/jquery.evently.js"><tt class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">here</span></tt></a></td>
</tr>
<tr><td>other files</td>
<td>All other files are already present.</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>If we export our CouchApp to our CouchDB again (<tt class="docutils literal"><span class="pre">enotes$</span> <span class="pre">couchapp</span> <span class="pre">push</span> <span class="pre">enotes</span></tt>) and open the exported CouchApp (<tt class="docutils literal"><span class="pre">http://localhost:5984/enotes/_design/enotes/index.html</span></tt>), we will see that the appearance of the <tt class="docutils literal"><span class="pre">index.html</span></tt> has changed.</p>
<blockquote>
<div><img alt="_images/4_jQuery.png" src="_images/4_jQuery.png" />
</div></blockquote>
<p>This change has happened solely because of the reference to the additional JavaScript libraries. The reason the graphics have been added is due to jQuery. In our <tt class="docutils literal"><span class="pre">index.html</span></tt> we have already set certain attributes that tell jQuery how to design the elements (like for example hyperlinks as buttons).</p>
<p>If you click on the button in the lower right labeled &#8220;Add Item&#8221;, our &#8220;Add Item&#8221; subpage is shown. This happens, because the hyperlink behind this button links to <tt class="docutils literal"><span class="pre">#addPage</span></tt>. jQuery interpretes this link and loads the subpage with the id &#8220;addPage&#8221;.</p>
</div>
<div class="section" id="logic-js">
<h3>logic.js<a class="headerlink" href="#logic-js" title="Permalink to this headline">¶</a></h3>
<p>Finally, the file <tt class="docutils literal"><span class="pre">logic.js</span></tt> handles the program logic unique to our application. Here the functions are defined or linked to, that are executed when a certain event is triggered in our HTML file.</p>
<p>Since it does not exist yet, we have to create it. It should be located at <tt class="docutils literal"><span class="pre">/_attachments/logic.js</span></tt>. Now, lets fill in some code!</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">$dbname</span> <span class="o">=</span> <span class="s2">&quot;enotes&quot;</span><span class="p">;</span>
<span class="nx">$appname</span><span class="o">=</span> <span class="s2">&quot;enotes&quot;</span><span class="p">;</span>
<span class="nx">$db</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="nx">$dbname</span><span class="p">);</span>

<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span> <span class="o">=</span>    <span class="p">{</span> <span class="s2">&quot;tagSelected&quot;</span> <span class="o">:</span> <span class="s2">&quot;NOTAG&quot;</span>
                <span class="p">,</span> <span class="s2">&quot;idSelected&quot;</span> <span class="o">:</span> <span class="mi">0</span>
                <span class="p">,</span> <span class="s2">&quot;docEdited&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span>
                <span class="p">,</span> <span class="s2">&quot;tagsUsed&quot;</span>  <span class="o">:</span> <span class="p">[]</span>
                <span class="p">,</span> <span class="s2">&quot;textSearchString&quot;</span> <span class="o">:</span> <span class="kc">false</span>
                <span class="p">,</span> <span class="s2">&quot;titleSearchString&quot;</span> <span class="o">:</span> <span class="kc">false</span>
                <span class="p">,</span> <span class="s2">&quot;tagSelected&quot;</span> <span class="o">:</span> <span class="kc">false</span>
                <span class="p">};</span>
</pre></div>
</div>
<p>This first part creates the variables <tt class="docutils literal"><span class="pre">$dbname</span></tt>, <tt class="docutils literal"><span class="pre">$appname</span></tt> and <tt class="docutils literal"><span class="pre">$db</span></tt>. As you may have guessed, the first two entries denote the name of the database we are using and the second one states the name of our CouchApp. The third variable defines our database connection. <tt class="docutils literal"><span class="pre">$.couch.db($dbname)</span></tt> is a method that is located within the file <tt class="docutils literal"><span class="pre">/vendor/couchapp/_attachments/jquery.couch.js</span></tt>.
The command <tt class="docutils literal"><span class="pre">$(&quot;body&quot;).data</span></tt> is a jQuery specific method. It attaches any information in JSON format to a given DOM element. In our case it is the <tt class="docutils literal"><span class="pre">body</span></tt> element this information is attached to. This defines the initial state our CouchApp is in when it is started.</p>
<p>We will go on by adding the following lines to the same file:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">couch</span><span class="p">.</span><span class="nx">app</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#addContent&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;editContent&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#addPage&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;addPage&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tagListPage&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;tagListPage&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tagListContent&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;tagListContent&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#titleListPage&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;titleListPage&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#titleListContent&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;titleListContent&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#editPage&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;editPage&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#editContent&quot;</span><span class="p">).</span><span class="nx">evently</span><span class="p">(</span><span class="s2">&quot;editContent&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The functions we just called links certain links inside the HTML file (like <tt class="docutils literal"><span class="pre">#addPage</span></tt>) to evently events. At this point we only add links to eight functions. For our CouchApp to work properly, we will come back here to add some more links later on.
Notice that both <tt class="docutils literal"><span class="pre">#addContent</span></tt> and <tt class="docutils literal"><span class="pre">#editContent</span></tt> link to the same element (<tt class="docutils literal"><span class="pre">editContent</span></tt>) since they will use the same method and layout to display information.</p>
</div>
</div>
<div class="section" id="action-code-evently">
<h2>Action Code / Evently<a class="headerlink" href="#action-code-evently" title="Permalink to this headline">¶</a></h2>
<p>Now we will add some code that is only executed when certain events are triggered (like clicking on a hyperlink). We will use evently to help us organise these event-based functions, but also have to add certain pieces of code to other places.</p>
<p>As we have encountered before, CouchApps are organised by maintaining a directory tree. This directory tree represents hierarchies. We can define functions for evently by storing these in the <tt class="docutils literal"><span class="pre">evently</span></tt> sub folder, we will create right now. Each function is located at a folder of its own inside the <tt class="docutils literal"><span class="pre">evently</span></tt> directory and replaces any already available function with the same name.</p>
<p>At the beginning of every chapter you will be presented with a diagram of folders and files you have to create. If you get confused during the passages of text you can refer to this graphics to reorientate.</p>
<div class="section" id="addpage-event">
<h3>addPage - Event<a class="headerlink" href="#addpage-event" title="Permalink to this headline">¶</a></h3>
<p class="graphviz">
<img src="_images/graphviz-6a46964039e68258669ffe6a460894096c0784af.png" alt="digraph addpage {
node [fontname=Verdana,fontsize=10]
node [style=filled]
node [fillcolor=&quot;#EEEEEE&quot;]
node [color=&quot;#EEEEEE&quot;]
edge [color=&quot;#31CEF0&quot;]
graph [size=&quot;10,9&quot;]
graph [ranksep=0.00]
graph [nodesep=0.00]
// graph [ratio=4]
graph [rankdir=TB]
// graph [orientation=landscape]
graph [ratio=auto]
graph [labelloc=t]

&quot;enotes&quot; [shape=box, color=grey]
&quot;evently&quot; [color=&quot;grey&quot;]
&quot;addPage&quot; [color=&quot;grey&quot;]
&quot;_init&quot; [color=&quot;grey&quot;]
&quot;selectors&quot; [color=&quot;grey&quot;]
&quot;input&quot; [color=&quot;grey&quot;]
&quot;editContent&quot; [color=&quot;grey&quot;]
&quot;shownote&quot; [color=&quot;grey&quot;]
&quot;titleListContent&quot; [color=&quot;grey&quot;]
&quot;updateTitleList&quot; [color=&quot;grey&quot;]
&quot;  selectors&quot; [color=&quot;grey&quot;]
&quot;a &quot; [color=&quot;grey&quot;]
&quot;titleListPage&quot; [color=&quot;grey&quot;]

&quot;enotes&quot; -&gt; &quot;evently&quot;
        &quot;evently&quot; -&gt; &quot;addPage&quot;
        &quot;addPage&quot; -&gt; &quot;pagebeforeshow.js&quot;
        &quot;addPage&quot; -&gt; &quot;_init&quot;
        &quot;_init&quot; -&gt; &quot;selectors&quot;
        &quot;selectors&quot; -&gt; &quot;input&quot;
        &quot;input&quot; -&gt; &quot;click.js&quot;
        &quot;evently&quot; -&gt; &quot;editContent&quot;
        &quot;editContent&quot; -&gt; &quot;shownote&quot;
        &quot;shownote&quot; -&gt; &quot;data.js&quot;
        &quot;shownote&quot; -&gt; &quot;async.js&quot;
        &quot;shownote&quot; -&gt; &quot;mustache.html&quot;
        &quot;shownote&quot; -&gt; &quot;after.js&quot;
        &quot;evently&quot; -&gt; &quot;titleListContent&quot;
        &quot;titleListContent&quot; -&gt; &quot;updateTitleList&quot;
        &quot;updateTitleList&quot; -&gt; &quot; async.js&quot;
        &quot;updateTitleList&quot; -&gt; &quot; data.js&quot;
        &quot;updateTitleList&quot; -&gt; &quot; mustache.html&quot;
        &quot;updateTitleList&quot; -&gt; &quot;  selectors&quot;
        &quot;  selectors&quot; -&gt; &quot;a &quot;
        &quot;a &quot; -&gt; &quot; click.js&quot;

&quot;evently&quot; -&gt; &quot;titleListPage&quot;
&quot;titleListPage&quot; -&gt; &quot; pagebeforeshow.js&quot;
}" />
</p>
<p>There has to be added a folder for our <tt class="docutils literal"><span class="pre">addPage</span></tt> link inside the <tt class="docutils literal"><span class="pre">evently</span></tt> folder. Inside this <tt class="docutils literal"><span class="pre">addPage</span></tt> folder we will create a file named <tt class="docutils literal"><span class="pre">pagebeforeshow.js</span></tt>. As the name tells us, the content within this file is executed before a specific page is shown. Fill it with the following code:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/addPage/pagebeforeshow.js&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">)</span>
        <span class="c1">// indicates &#39;new note&#39;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">idSelected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#addContent&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;shownote&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This mainly calles the function <tt class="docutils literal"><span class="pre">shownote</span></tt> from the element <tt class="docutils literal"><span class="pre">addContent</span></tt> (which is linked to an evently event named <tt class="docutils literal"><span class="pre">editContent</span></tt>. This does not yet exist, but we will create it soon).</p>
<p>Now, we have to add some more folders. Inside the <tt class="docutils literal"><span class="pre">addPage</span></tt> directory, we have to create a folder with the name <tt class="docutils literal"><span class="pre">_init</span></tt>. This stands for the init-function that is executed when the function is loaded. Here, add another folder named <tt class="docutils literal"><span class="pre">selectors</span></tt>. The content of this new folder describes DOM elements to which content added further on applies to. We will add a directory named <tt class="docutils literal"><span class="pre">input</span></tt> inside the <tt class="docutils literal"><span class="pre">selectors</span></tt> folder. Now, inside <tt class="docutils literal"><span class="pre">input</span></tt>, create a file with the name <tt class="docutils literal"><span class="pre">click.js</span></tt>.
This directory structure will be interpreted as a jQuery function by the couchapp application. It would look like this: <tt class="docutils literal"><span class="pre">$(&quot;input&quot;).click</span></tt>.</p>
<p>At last, we can define the function that is executed when a click happens to the &#8220;input&#8221; element our directory structure referres to. We do this by adding the following code to <tt class="docutils literal"><span class="pre">click.js</span></tt>:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;addPage - shownote - click.js&quot;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">docvalue</span><span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">docEdited</span><span class="p">;</span> <span class="c1">//edata.docEdited;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">docvalue</span><span class="p">);</span>
        <span class="kd">var</span>
                <span class="nx">title</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
                <span class="nx">text</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;textarea#editTextField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
                <span class="nx">tags</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[name=tags]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagSelected</span><span class="o">=</span><span class="nx">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span> <span class="o">:</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="s2">&quot;TextNote&quot;</span> <span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;note&quot;</span> <span class="o">:</span> <span class="p">{</span>
                                <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span> <span class="o">:</span> <span class="nx">text</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="nx">tags</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">};</span>
        <span class="c1">//no fields for docid and docrev in &#39;addpage&#39; which is new doc</span>
        <span class="c1">// could check docvalue._id = 0</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
        <span class="nx">doStoreDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span> <span class="c1">//braucht das alte doc fuer die revision?</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;addPage after store&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#editContent&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;shownote&quot;</span><span class="p">);</span>  <span class="c1">//possible an argument, how to use?</span>
        <span class="c1">//      the saving of the id comes too late, async issue</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">changePage</span><span class="p">(</span><span class="s2">&quot;#titleListPage&quot;</span><span class="p">,</span> <span class="s2">&quot;slidedown&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="c1">// id is found too late</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition-todo admonition " id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">explain content of click.js</p>
</div>
<p>Take a look at the line <tt class="docutils literal"><span class="pre">$(&quot;#editContent&quot;).trigger(&quot;shownote&quot;);</span></tt>. Here, the function <tt class="docutils literal"><span class="pre">shownote</span></tt> which is linked to <tt class="docutils literal"><span class="pre">#editContent</span></tt> is called.
Since this function does not yet exist, we have to add a second event to the <tt class="docutils literal"><span class="pre">evently</span></tt> folder called <tt class="docutils literal"><span class="pre">editContent</span></tt> (remember our <tt class="docutils literal"><span class="pre">logic.js</span></tt> - there we assign the function <tt class="docutils literal"><span class="pre">editContent</span></tt> to the link <tt class="docutils literal"><span class="pre">#addContent</span></tt>). The actual link <tt class="docutils literal"><span class="pre">#addContent</span></tt> that calls the function <tt class="docutils literal"><span class="pre">editContent</span></tt> is located in <tt class="docutils literal"><span class="pre">index.html</span></tt> inside the <tt class="docutils literal"><span class="pre">addPage</span></tt> page.
To create this function, again make a folder called <tt class="docutils literal"><span class="pre">editContent</span></tt> inside our <tt class="docutils literal"><span class="pre">evently</span></tt> folder. Within this new folder we create another directory called <tt class="docutils literal"><span class="pre">shownote</span></tt> - this is the name of our function.
Within this directory create the following files with the following content:</p>
<ul>
<li><p class="first"><strong>data.js</strong>: We can see that the content of a stored note is loaded into the variable <tt class="docutils literal"><span class="pre">noteContent</span></tt>:</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">note</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/editContent/shownote/data.js&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;bdoy&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">docEdited</span><span class="o">=</span><span class="nx">data</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">noteContent</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">TextNote</span><span class="p">.</span><span class="nx">note</span><span class="p">;</span>
    <span class="nx">noteContent</span><span class="p">.</span><span class="nx">taglist</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">TextNote</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">noteContent</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;put doc in docEdited&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">noteContent</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>async.js</strong>: Within this code, remember the call for the function <tt class="docutils literal"><span class="pre">makeEmptyNote()</span></tt> - we will add it later on.</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">idvalue</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">idSelected</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">emptydata</span> <span class="o">=</span> <span class="nx">makeEmptyNote</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/editContent/shownote/async.js: edit content - id is found &quot;</span> <span class="o">+</span> <span class="nx">idvalue</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagSelected</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emptydata</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">idvalue</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">doGetDoc</span> <span class="p">(</span><span class="nx">idvalue</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
                        <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span><span class="nx">callback</span> <span class="p">(</span><span class="nx">emptydata</span><span class="p">)};</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>mustache.html</strong>:</p>
<blockquote>
<div><div class="highlight-html"><pre>&lt;div&gt;
    &lt;!-- &lt;p&gt; mustache of editContent/_init id= {{_id}} rev= {{_rev}} &lt;/p&gt; --&gt;
    &lt;a class=docidrev "docid"={{_id}}  "docrev"={{_rev}} /&gt;
    &lt;div data-role="fieldcontain"&gt;
        &lt;label for="title"&gt;Title:&lt;/label&gt;
        &lt;input id="editTitleField" name="title" type="text" data-role="none"
            value="{{title}}" &gt;
    &lt;/div&gt;
    &lt;div data-role="fieldcontain"&gt;
        &lt;label for="text"&gt;Text:&lt;/label&gt;
        &lt;textarea id="editTextField" name="text" cols="40" rows="8" &gt;{{text}}
        &lt;/textarea&gt;
    &lt;/div&gt;
    &lt;div data-role="fieldcontain" class="ui-widget&gt;
        &lt;label for="tags"&gt;Tags:&lt;/label&gt;
        &lt;input id="editTagsField" name="tags" type="text" data-role="none"
            value="{{taglist}}" /&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>after.js</strong>:</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">split</span><span class="p">(</span> <span class="nx">val</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">val</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="sr">/,\s*/</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/shownote/after.js&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">thetags</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagsUsed</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">thetags</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#editTagsField&quot;</span><span class="p">).</span><span class="nx">autocomplete</span><span class="p">({</span><span class="nx">source</span><span class="o">:</span><span class="nx">thetags</span><span class="p">,</span>
        <span class="nx">max</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="nx">highlightItem</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">multiple</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">multipleSeparator</span><span class="o">:</span> <span class="s2">&quot; &quot;</span>
        <span class="p">});</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>Since the titleListPage is referred to in the <tt class="docutils literal"><span class="pre">click.js</span></tt> function of the <tt class="docutils literal"><span class="pre">addPage</span></tt> event, we need to add the folder <tt class="docutils literal"><span class="pre">titleListPage</span></tt> to the <tt class="docutils literal"><span class="pre">evently</span></tt> folder. There create the file <tt class="docutils literal"><span class="pre">pagebeforeshow.js</span></tt> and fill it with the following code:</p>
<div class="highlight-js"><div class="highlight"><pre>    <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/titleListPage/pagebeforeshow.js&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#titleListContent&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;updateTitleList&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>As we can see, the funcion <tt class="docutils literal"><span class="pre">updateTitleList</span></tt> from the object <tt class="docutils literal"><span class="pre">titleListContent</span></tt> ist called. We have to create this folder. So, inside <tt class="docutils literal"><span class="pre">evently</span></tt> create a directory named <tt class="docutils literal"><span class="pre">titleListContent</span></tt>. Within that make another one called <tt class="docutils literal"><span class="pre">updateTitleList</span></tt>. Inside this directory, create one named <tt class="docutils literal"><span class="pre">selectors</span></tt> and then one named <tt class="docutils literal"><span class="pre">a</span></tt>. Finally, within that one make a file called <tt class="docutils literal"><span class="pre">click.js</span></tt> and fill it with the following code:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">pass</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;selectNote in evently/titleListContent/updateTitleList/selectors/a&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">idval</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">idSelected</span><span class="o">=</span><span class="nx">idval</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Back in the <tt class="docutils literal"><span class="pre">updateTitleList</span></tt> folder (take a look at the graphic at the beginning of this section if you got lost), we have to add some files quite different from the last time:</p>
<ul>
<li><p class="first"><strong>data.js</strong>: This file is the main component of events. Here, data specific action is taking place. Usually, one would refer to a CochDB view or gather data otherwise here. In our case, the autocompletion field (which itslef is defined in the file <tt class="docutils literal"><span class="pre">mustache.html</span></tt>) is set up.</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre>    <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/titleListContent/updateTitleList/data.js&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagSelected</span><span class="p">;</span>
<span class="nx">data</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">;</span>
<span class="k">return</span>  <span class="nx">data</span><span class="p">;</span>
</pre></div>
</div>
<p>}</p>
</div></blockquote>
</li>
<li><p class="first"><strong>async.js</strong>:</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/titleListContent/updateTitleList/async.js&quot;</span> <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagSelected</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">titleWord</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">titleSearchString</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">textWord</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">textSearchString</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doView</span> <span class="p">(</span><span class="s2">&quot;DocbyTag2&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="nx">tag</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">titleWord</span><span class="p">)</span> <span class="p">{</span><span class="nx">doView</span> <span class="p">(</span><span class="s2">&quot;byTitleWord&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;reduce&quot;</span> <span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="nx">titleWord</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">textWord</span><span class="p">)</span> <span class="p">{</span><span class="nx">doView</span> <span class="p">(</span><span class="s2">&quot;byTextWord&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;reduce&quot;</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span> <span class="o">:</span> <span class="nx">textWord</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>mustache.html</strong>: Here the layout of the editPage/addPage is defined. Fill it with the following code.</p>
<blockquote>
<div><div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">&quot;titleslist&quot;</span> <span class="na">data-role=</span><span class="s">&quot;listview&quot;</span><span class="nt">&gt;</span>
    {{#rows}}
        <span class="nt">&lt;li&gt;</span>
        {{#value}}
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;title&quot;</span> <span class="na">href=</span><span class="s">&quot;#editPage&quot;</span> <span class="na">id=</span><span class="s">{{_id}}</span> <span class="nt">&gt;</span>
        {{#TextNote}}
        {{#note}}
              {{title}}
        {{/note}}
        {{/TextNote}}
         <span class="nt">&lt;/a&gt;</span>
        {{/value}}
        <span class="nt">&lt;/li&gt;</span>
    {{/rows}}
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>Remember, anything between <tt class="docutils literal"><span class="pre">{{```and</span> <span class="pre">``}}</span></tt> will be replaced by the corresponding JSON value when this file is used later on.</p>
<ul>
<li><p class="first"><strong>after.js</strong>:</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/titleListContent/updateTitleList/after.js&quot;</span> <span class="p">)</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#titleslist&quot;</span><span class="p">).</span><span class="nx">listview</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;after listview  &quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>We are calling a JavaScript function called <tt class="docutils literal"><span class="pre">makeEmptyNote</span></tt> in our code here. This does not yet exist, so we have to create it. It should be located in <tt class="docutils literal"><span class="pre">logic.js</span></tt> inside our <tt class="docutils literal"><span class="pre">/_attachments</span></tt> folder. Just open this file and add the following lines to it at the bottom:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">makeEmptyNote</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;logic.js - makeEmptyNote&quot;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">emptynote</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span> <span class="o">:</span>  <span class="s2">&quot;&quot;</span>
                <span class="p">,</span> <span class="s2">&quot;_rev&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span>
                <span class="p">,</span> <span class="s2">&quot;type&quot;</span> <span class="o">:</span> <span class="s2">&quot;note&quot;</span>
                <span class="p">,</span> <span class="s2">&quot;TextNote&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;note&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span>
                        <span class="p">,</span> <span class="s2">&quot;text&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span>
                        <span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="p">[]</span>
                <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">emptynote</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If we were to take a look at our CouchApp right now and would add a new note, we would see the following:</p>
<img alt="_images/4_add.png" src="_images/4_add.png" />
</div>
<div class="section" id="save-notes">
<h3>Save Notes<a class="headerlink" href="#save-notes" title="Permalink to this headline">¶</a></h3>
<p>To be able to save a new note, we have to click on the &#8220;add new - Submit&#8221; button. But this does not work yet, because we are still missing code to save our entry. When the page is loaded, the code in <tt class="docutils literal"><span class="pre">evently/addPage/_init/selectors/input</span></tt> is attached to each input-type element. Therefore, if we click on the button, the code stored within the <tt class="docutils literal"><span class="pre">click.js</span></tt> file we edited earlier is fired. There is exactly one very important line in this code, namely <tt class="docutils literal"><span class="pre">doStoreDocument(document);</span></tt>. This is a function call of another function that still has to be included in our <tt class="docutils literal"><span class="pre">logic.js</span></tt>. So lets add the following code to <tt class="docutils literal"><span class="pre">logic.js</span></tt> inside our <tt class="docutils literal"><span class="pre">/_attachments</span></tt> directory:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">doStoreDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$db</span><span class="p">.</span><span class="nx">saveDoc</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">async</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">docEdited</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;store - success&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>  <span class="nx">data</span><span class="p">.</span><span class="nx">rev</span><span class="p">);</span>
                        <span class="c1">//  $.mobile.changePage(&quot;#editPage&quot;, &quot;slidedown&quot;, true, true);</span>
                <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Cannot save new document.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here a CouchDB specific function (<tt class="docutils literal"><span class="pre">$db.saveDoc(document,</span> <span class="pre">{</span></tt>) is called on the <tt class="docutils literal"><span class="pre">$db</span></tt> object AJAX style to actually do the saving.</p>
</div>
<div class="section" id="review-the-document">
<h3>Review the Document<a class="headerlink" href="#review-the-document" title="Permalink to this headline">¶</a></h3>
<p>I encourage you to export our CouchApp (<tt class="docutils literal"><span class="pre">¼enotes</span> <span class="pre">couchapp</span> <span class="pre">push</span> <span class="pre">enotes</span></tt>) and open it in your web-browser. Now, create a new note inside our running CouchApp and save it. Don&#8217;t be shocked if you won&#8217;t see it afterwards in the list of available notes or get any error messages in a debug window - if you use any (this code is still to be implemented). What I want to show you now is the actual document that was saved into our CouchDB by clicking on &#8220;add new - Submit&#8221;.
In the web browser, open the page <a class="reference external" href="http://127.0.0.1:5984/_utils/database.html?enotes">http://127.0.0.1:5984/_utils/database.html?enotes</a> .
There you will not only find our <tt class="docutils literal"><span class="pre">_design/enotes</span></tt> document, but also another one with random ID. Click on it to see its content.</p>
<img alt="_images/4_document.png" src="_images/4_document.png" />
<p>As we can see, this is the document that holds our new note.</p>
<p>Now, we have to make it visible in our CouchApp. So far, we can create new notes, but cannot look at them.</p>
</div>
<div class="section" id="list-used-tags">
<h3>List used Tags<a class="headerlink" href="#list-used-tags" title="Permalink to this headline">¶</a></h3>
<p class="graphviz">
<img src="_images/graphviz-0073b2456451e7a0c5275945d8a5a28cdd86f1af.png" alt="digraph saveNote {
node [fontname=Verdana,fontsize=10]
node [style=filled]
node [fillcolor=&quot;#EEEEEE&quot;]
node [color=&quot;#EEEEEE&quot;]
edge [color=&quot;#31CEF0&quot;]
graph [size=&quot;10,9&quot;]
graph [ranksep=0.20]
graph [nodesep=0.20]
// graph [ratio=4]
graph [rankdir=TB]
// graph [orientation=landscape]
graph [ratio=auto]
graph [labelloc=t]

&quot;enotes&quot; [shape=box, color=grey]
&quot;evently&quot; [color=grey]
&quot;tagListPage&quot; [color=grey]
&quot;selectors&quot; [color=grey]
&quot;a&quot; [color=grey]
&quot;tagListContent&quot; [color=grey]
&quot;_init&quot; [color=grey]
&quot;selectors &quot; [color=grey]
&quot;a &quot; [color=grey]
&quot;views&quot; [color=grey]
&quot;DocbyTag&quot; [color=grey]

&quot;enotes&quot; -&gt; &quot;evently&quot;
        &quot;evently&quot; -&gt; &quot;tagListPage&quot;
        &quot;tagListPage&quot; -&gt; &quot;pagebeforeshow.js&quot;
        &quot;tagListPage&quot; -&gt; &quot;selectors&quot;
        &quot;selectors&quot; -&gt; &quot;a&quot;
        &quot;a&quot; -&gt; &quot;click.js&quot;
        &quot;evently&quot; -&gt; &quot;tagListContent&quot;
        &quot;tagListContent&quot; -&gt; &quot;_init&quot;
        &quot;_init&quot; -&gt; &quot;mustache.html&quot;
        &quot;_init&quot; -&gt; &quot;after.js&quot;
        &quot;_init&quot; -&gt; &quot;data.js&quot;
        &quot;_init&quot; -&gt; &quot;query.json&quot;
        &quot;_init&quot; -&gt; &quot;selectors &quot;
        &quot;selectors &quot; -&gt; &quot;a &quot;
        &quot;a &quot; -&gt; &quot; click.js&quot;
&quot;enotes&quot; -&gt; &quot;views&quot;
        &quot;views&quot; -&gt; &quot;DocbyTag&quot;
        &quot;DocbyTag&quot; -&gt; &quot;map.js&quot;
        &quot;DocbyTag&quot; -&gt; &quot;reduce.js&quot;
}" />
</p>
<p>We want the list of available notes to be refreshed every time the main page is shown. The main page is the one with <tt class="docutils literal"><span class="pre">id=tagListContent</span></tt> which shows all notes available grouped by tags. To accieve this, we need again some evently code and a specific CouchDB view that groups our notes according to their tags.</p>
<p>First, we create a new folder in our <tt class="docutils literal"><span class="pre">evently</span></tt> folder named <tt class="docutils literal"><span class="pre">tagListPage</span></tt>. Within this new folder, create a file called <tt class="docutils literal"><span class="pre">pagebeforeshow.js</span></tt>. This code is executed right before our &#8220;tagListPage&#8221; is shown. Insert:</p>
<div class="highlight-js"><div class="highlight"><pre>    <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/tagListPage/pagebeforeshow.js&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">)</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tagListContent&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;_init&quot;</span><span class="p">);</span> <span class="c1">// (&quot;updateTagList&quot; );</span>
            <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As we can see, the event <tt class="docutils literal"><span class="pre">_init</span></tt> of the object <tt class="docutils literal"><span class="pre">tagListContent</span></tt> is called. We will add this function shortly. But first, create an additional directory named <tt class="docutils literal"><span class="pre">selectors</span></tt> and then, inside the one before, one called <tt class="docutils literal"><span class="pre">a</span></tt>. Within <tt class="docutils literal"><span class="pre">a</span></tt> create a file called <tt class="docutils literal"><span class="pre">click.js</span></tt>. Fill it with the following code:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
    <span class="c1">//probably currentTarget needed because this is a button</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;tagListPage - selectors - a -click.js &quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">aid</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;op&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;clicked - the operation is &quot;</span> <span class="o">+</span> <span class="nx">aid</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we will create the function which is called from the previous <tt class="docutils literal"><span class="pre">beforepageshow.js</span></tt> by, creating an additional folder inside <tt class="docutils literal"><span class="pre">evently</span></tt> named <tt class="docutils literal"><span class="pre">tagListContent</span></tt>.
Now, the function <tt class="docutils literal"><span class="pre">_init</span></tt> is defined by creating a folder named <tt class="docutils literal"><span class="pre">_init</span></tt> inside the <tt class="docutils literal"><span class="pre">tagListContent</span></tt> folder. Here we will add the files we know from before:</p>
<ul>
<li><p class="first"><strong>mustache.html</strong>: This is the actual design of one entry in the tag list (the list that groups notes by their tags)</p>
<blockquote>
<div><div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">&quot;taglist&quot;</span> <span class="na">data-role=</span><span class="s">&quot;listview&quot;</span><span class="nt">&gt;</span>
{{#rows}}
    <span class="nt">&lt;li&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#titleListPage&quot;</span> <span class="na">id=</span><span class="s">{{key}}</span><span class="nt">&gt;</span>{{key}} occurs {{value}} times<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
{{/rows}}
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>Take a look at <tt class="docutils literal"><span class="pre">{{key}}</span></tt> and <tt class="docutils literal"><span class="pre">{{value}}</span></tt> - later, these occurences will be replaced by the corresponding values from a CouchDB query which itself returns key - value pairs.</p>
<ul>
<li><p class="first"><strong>data.js</strong>:</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/tagListContent/_init/data.js&quot;</span> <span class="p">)</span>
    <span class="kd">var</span> <span class="nx">thetags</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
        <span class="p">{</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">t</span><span class="p">;});</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagsUsed</span> <span class="o">=</span> <span class="nx">thetags</span><span class="p">;</span>
    <span class="c1">// store them for later use in input gui</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>query.json</strong>: Here the view that will be used to query data from our CouchDB is defined.</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;view&quot;</span> <span class="o">:</span> <span class="s2">&quot;DocbyTag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;group&quot;</span>  <span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>We will have to create the view named <tt class="docutils literal"><span class="pre">DocbyTag</span></tt> later to be able to use it.</p>
<ul>
<li><p class="first"><strong>after.js</strong>:</p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/tagListContent/after.js&quot;</span> <span class="p">)</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#taglist&quot;</span><span class="p">).</span><span class="nx">listview</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>A <tt class="docutils literal"><span class="pre">selectors</span></tt> folder should be created: Inside the directory <tt class="docutils literal"><span class="pre">_init</span></tt> create a folder called <tt class="docutils literal"><span class="pre">selectors</span></tt>, then, inside it, another one called <tt class="docutils literal"><span class="pre">a</span></tt>. Now, as before, create a file named <tt class="docutils literal"><span class="pre">click.js</span></tt>.</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">pass</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/tagListContent/_init/selectors/a/click.js&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagSelected</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we have to define the view for the query to the database. In our example, the view is called <tt class="docutils literal"><span class="pre">DocbyTag</span></tt>. So, we have to move to the <tt class="docutils literal"><span class="pre">./views</span></tt> folder and add one with the name <tt class="docutils literal"><span class="pre">DocbyTag</span></tt>.
Inside this folder, we can create two files representing a CouchDB view: one called <tt class="docutils literal"><span class="pre">map.js</span></tt> and the other one called <tt class="docutils literal"><span class="pre">reduce.js</span></tt>.
The code we have to enter to each of them is as follows:</p>
<ul>
<li><p class="first"><strong>map.js</strong></p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">TextNote</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">words</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">TextNote</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">tags</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">words</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">words</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">();</span>
                        <span class="nx">emit</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>reduce.js</strong></p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>If we export our CouchApp again and open it, we will see one entry:</p>
<img alt="_images/4_onetag.png" src="_images/4_onetag.png" />
<p>This is the summary of all notes in our CouchApp so far. As we have just one note inside our CouchApp, the list shows only one tag with only one occurence.
But if we click on it, nothing happens yet, because we have not coded the part yet to list all notes from a specific tag.</p>
</div>
<div class="section" id="list-notes-from-tag">
<h3>List Notes from Tag<a class="headerlink" href="#list-notes-from-tag" title="Permalink to this headline">¶</a></h3>
<p class="graphviz">
<img src="_images/graphviz-a6da2fe1a356cc9c333209297f0cc6a1c1cbcdc1.png" alt="digraph {
node [fontname=Verdana,fontsize=10]
node [style=filled]
node [fillcolor=&quot;#EEEEEE&quot;]
node [color=&quot;#EEEEEE&quot;]
edge [color=&quot;#31CEF0&quot;]
graph [size=&quot;10,9&quot;]
graph [ranksep=0.20]
graph [nodesep=0.50]
// graph [ratio=4]
graph [rankdir=TB]
// graph [orientation=landscape]
graph [ratio=auto]
graph [labelloc=t]

&quot;enotes&quot; [shape=box, color=grey]
&quot;evently&quot; [color=grey]
&quot;titleListContent&quot; [color=grey]
&quot;updateTitleList&quot; [color=grey]
&quot;selectors&quot; [color=grey]
&quot;a&quot; [color=grey]
&quot;views&quot; [color=grey]
&quot;DocbyTag2&quot; [color=grey]

&quot;enotes&quot; -&gt; &quot;evently&quot;
        &quot;evently&quot; -&gt; &quot;titleListContent&quot;
        &quot;titleListContent&quot; -&gt; &quot;updateTitleList&quot;
&quot;updateTitleList&quot; -&gt; &quot;selectors&quot;
&quot;selectors&quot; -&gt; &quot;a&quot;
&quot;a&quot; -&gt; &quot;click.js&quot;

&quot;enotes&quot; -&gt; &quot;views&quot;
        &quot;views&quot; -&gt; &quot;DocbyTag2&quot;
        &quot;DocbyTag2&quot; -&gt; &quot;map.js&quot;
}" />
</p>
<p>We want the list of notes to be refreshed every time the page is shown. The list itself is located inside <tt class="docutils literal"><span class="pre">index.html</span></tt> at the DIV with <tt class="docutils literal"><span class="pre">id=titleListContent</span></tt>.
So, if we move to this evently event and open the file <tt class="docutils literal"><span class="pre">/evently/titleListContent/updateTitleList/async.js</span></tt> we can see a function call for <tt class="docutils literal"><span class="pre">doView</span></tt>.
This function does not exist yet. We will have to add it to our already infamous``logic.js`` inside the <tt class="docutils literal"><span class="pre">/_attachments</span></tt> folder:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">doView</span> <span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">json</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;dbViewWithKey &quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
        <span class="nx">$db</span><span class="p">.</span><span class="nx">view</span><span class="p">((</span><span class="nx">$appname</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">view</span><span class="p">),</span>
                <span class="nx">XXmerge</span> <span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">async</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                        <span class="p">},</span>
                        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Cannot find the document with id &quot;</span> <span class="o">+</span> <span class="nx">keyvalue</span><span class="p">);</span>
                        <span class="p">}</span>
    <span class="p">})</span>
        <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function needs another one, we will define right now, called <tt class="docutils literal"><span class="pre">XXmerge</span></tt>:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">XXmerge</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">ob</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">z</span> <span class="k">in</span> <span class="nx">ob</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ob</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">z</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">o</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">[</span><span class="nx">z</span><span class="p">];</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we create the view <tt class="docutils literal"><span class="pre">DocbyTag2</span></tt> which is used to request notes of a specific tag from the CouchDB. Go to the <tt class="docutils literal"><span class="pre">./views</span></tt> foder and add one with the name <tt class="docutils literal"><span class="pre">DocbyTag2</span></tt>. Inside this new folder, create a files representing our view:</p>
<ul>
<li><p class="first"><strong>map.js</strong></p>
<blockquote>
<div><div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">TextNote</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">words</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">TextNote</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">tags</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">words</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">words</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">();</span>
            <span class="nx">emit</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>We won&#8217;t need a reduce function here.</p>
<p>To signal the selection of an entry, we will have to add a selector for &#8220;a&#8221; to the <tt class="docutils literal"><span class="pre">updateTitleList</span></tt> event inside the <tt class="docutils literal"><span class="pre">evently</span></tt> folder: Create a new folder named <tt class="docutils literal"><span class="pre">selectors</span></tt> inside the <tt class="docutils literal"><span class="pre">updateTitleList</span></tt> folder which itself is located inside the <tt class="docutils literal"><span class="pre">titleListContent</span></tt> directory. In there, go on by creating another one named <tt class="docutils literal"><span class="pre">a</span></tt>. Inside this directory we will create a file named <tt class="docutils literal"><span class="pre">click.js</span></tt>. The content of this file should be:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">pass</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;selectNote in evently/titleListContent/updateTitleList/selectors/a&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">idval</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">idSelected</span><span class="o">=</span><span class="nx">idval</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This will set the <tt class="docutils literal"><span class="pre">idSelected</span></tt> value stored in the <tt class="docutils literal"><span class="pre">data</span></tt> element of the <tt class="docutils literal"><span class="pre">body</span></tt> to the ID of the selected note. This is important later on when we will actually display the content of a note.</p>
<p>This is what you will see, if you click on any tagList item now:</p>
<img alt="_images/4_onenote.png" src="_images/4_onenote.png" />
<p>Now, we will implement the parts that allow us to open and edit an existing note.</p>
</div>
<div class="section" id="open-notes">
<h3>Open Notes<a class="headerlink" href="#open-notes" title="Permalink to this headline">¶</a></h3>
<p class="graphviz">
<img src="_images/graphviz-b15c5b89d19b8ffaf8c06e9d09bca44a8270df1f.png" alt="digraph opennotes {
node [fontname=Verdana,fontsize=10]
node [style=filled]
node [fillcolor=&quot;#EEEEEE&quot;]
node [color=&quot;#EEEEEE&quot;]
edge [color=&quot;#31CEF0&quot;]
graph [size=&quot;10,9&quot;]
graph [ranksep=0.20]
graph [nodesep=0.50]
// graph [ratio=4]
graph [rankdir=TB]
// graph [orientation=landscape]
graph [ratio=auto]
graph [labelloc=t]

&quot;enotes&quot; [shape=box, color=grey]
&quot;evently&quot; [color=grey]
&quot;editPage&quot; [color=grey]
&quot;_init&quot; [color=grey]
&quot;selectors&quot; [color=grey]
&quot;a[op=delete]&quot; [color=grey]
&quot;a[op=save]&quot; [color=grey]

&quot;enotes&quot; -&gt; &quot;evently&quot;
        &quot;evently&quot; -&gt; &quot;editPage&quot;
        &quot;editPage&quot; -&gt; &quot;pagebeforeshow.js&quot;
        &quot;editPage&quot; -&gt; &quot;_init&quot;
        &quot;_init&quot; -&gt; &quot;selectors&quot;
        &quot;selectors&quot; -&gt; &quot;a[op=delete]&quot;
        &quot;a[op=delete]&quot; -&gt; &quot;click.js&quot;
        &quot;selectors&quot; -&gt; &quot;a[op=save]&quot;
        &quot;a[op=save]&quot; -&gt; &quot; click.js&quot;
}" />
</p>
<p>To open a note, we need to implement another evently event.
Go to your <tt class="docutils literal"><span class="pre">evently</span></tt> folder and create a directory named <tt class="docutils literal"><span class="pre">editPage</span></tt>.</p>
<p>There you have to create the file <tt class="docutils literal"><span class="pre">pagebeforeshow.js</span></tt>. Its content should read as follows:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;evently/editPage/pagebeforeshow.js&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">)</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#editContent&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;shownote&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This seems familiar. The function <tt class="docutils literal"><span class="pre">shownote</span></tt> in the element <tt class="docutils literal"><span class="pre">editContent</span></tt> is triggered.
But within this <tt class="docutils literal"><span class="pre">shownote</span></tt> function, another one is called that does not yet exist. It has the name <tt class="docutils literal"><span class="pre">doGetDoc</span></tt>. We will add it to our <tt class="docutils literal"><span class="pre">./_attachments/logic.js</span></tt>:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">doGetDoc</span> <span class="p">(</span><span class="nx">docid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;doGetDoc &quot;</span> <span class="o">+</span> <span class="nx">docid</span><span class="p">);</span>
        <span class="nx">$db</span><span class="p">.</span><span class="nx">openDoc</span> <span class="p">(</span><span class="nx">docid</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Cannot find the document with id &quot;</span> <span class="o">+</span> <span class="nx">keyvalue</span><span class="p">);</span>
    <span class="p">}</span>
        <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, we will add a &#8220;_init&#8221; method by creating a directory called <tt class="docutils literal"><span class="pre">_init</span></tt> within the <tt class="docutils literal"><span class="pre">editPage</span></tt> folder. This function is executed when <em>editPage</em> is initialized. Inside <tt class="docutils literal"><span class="pre">_init</span></tt> create a <tt class="docutils literal"><span class="pre">selectors</span></tt> directory.
Here we have to add two elements to be selected, depending on whether we want to delete or save a note. Let&#8217;s take a look at an excerp of the editPage inside our <tt class="docutils literal"><span class="pre">index.html</span></tt>:</p>
<div class="highlight-js"><pre>...
&lt;a op="delete" href="#titleListPage"  data-role="button" data-theme="b"&gt;DELETE Note&lt;/a&gt;
...
&lt;a op="save" href="#titleListPage"  data-role="button" data-theme="a"&gt;SAVE Note&lt;/a&gt;
...</pre>
</div>
<p>As we can see, there are two <tt class="docutils literal"><span class="pre">a</span></tt> elements, one with the attribute <tt class="docutils literal"><span class="pre">op=&quot;delete&quot;</span></tt> and the other one with <tt class="docutils literal"><span class="pre">op=&quot;save&quot;</span></tt>. With CouchApp and Evently it is not only possible to attach a function to the <tt class="docutils literal"><span class="pre">a</span></tt> element, but also distinguish them by their attributes.
So, let&#8217;s add a function for the delete option. Still within <tt class="docutils literal"><span class="pre">selectors</span></tt> create a directory named <tt class="docutils literal"><span class="pre">a[op=delete]</span></tt>. I guess you have noticed how to include attributes in this notation. Enter our new directory and create a file called <tt class="docutils literal"><span class="pre">click.js</span></tt>, because we want do define an action to be executed when we click the delete button.
The content of this file should look like this:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
        <span class="c1">//probably currentTarget needed because this is a button</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;editPage - shownote - a - delete -click.js &quot;</span><span class="p">)</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">aid</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;op&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;clicked - the tag is &quot;</span> <span class="o">+</span> <span class="nx">aid</span> <span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;editContent/_init/selectors/a[op=delete]/click.js&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">docvalue</span><span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">docEdited</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">docvalue</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">docid</span> <span class="o">=</span> <span class="nx">docvalue</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
                <span class="nx">docrev</span> <span class="o">=</span><span class="nx">docvalue</span><span class="p">.</span><span class="nx">_rev</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;docid in delete &quot;</span> <span class="o">+</span> <span class="nx">docid</span> <span class="o">+</span> <span class="s2">&quot; rev &quot;</span> <span class="o">+</span> <span class="nx">docrev</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="nx">docid</span><span class="p">,</span> <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="nx">docrev</span><span class="p">};</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
        <span class="nx">doDeleteDocument</span> <span class="p">(</span><span class="nb">document</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;editPage after delete&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The most important part of this code is the line <tt class="docutils literal"><span class="pre">doDeleteDocument</span> <span class="pre">(document);</span></tt>. This represents a function that should be located inside <tt class="docutils literal"><span class="pre">/_attachments/logic.js</span></tt>. So, we will enter it there:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">doDeleteDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$db</span><span class="p">.</span><span class="nx">removeDoc</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">async</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">docEdited</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;document deleted - success&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>  <span class="nx">data</span><span class="p">.</span><span class="nx">rev</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Cannot delete document.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, we will include functionality to edit an existing note. As with the &#8220;delete&#8221; option, we need to create a folder inside <tt class="docutils literal"><span class="pre">./evently/editPage/_init/selectors</span></tt>. Only this time, we will name it <tt class="docutils literal"><span class="pre">a[op=save]</span></tt>.
Inside this folder, also add a <tt class="docutils literal"><span class="pre">click.js</span></tt> file and fill it with this code:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">);</span>
        <span class="c1">//probably currentTarget needed because this is a button</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;editPage - shownote - a save -click.js &quot;</span><span class="p">)</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">aid</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;op&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;clicked - the tag is &quot;</span> <span class="o">+</span> <span class="nx">aid</span> <span class="p">);</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;editContent/_init/selectors/a[op=save]/click.js&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">);</span>  <span class="c1">// why is this not availalbe here?</span>
        <span class="kd">var</span> <span class="nx">docvalue</span><span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">docEdited</span><span class="p">;</span> <span class="c1">//edata.docEdited;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">docvalue</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">docid</span> <span class="o">=</span> <span class="nx">docvalue</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
                <span class="nx">docrev</span> <span class="o">=</span><span class="nx">docvalue</span><span class="p">.</span><span class="nx">_rev</span><span class="p">,</span>
                <span class="nx">title</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[name=title]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
                <span class="nx">text</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;textarea#editTextField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
                <span class="nx">tags</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[name=tags]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">tagSelected</span><span class="o">=</span><span class="nx">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">();</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;docid in save doc &quot;</span> <span class="o">+</span> <span class="nx">docid</span> <span class="o">+</span> <span class="s2">&quot; rev &quot;</span> <span class="o">+</span> <span class="nx">docrev</span> <span class="o">+</span> <span class="s2">&quot; title &quot;</span> <span class="o">+</span> <span class="nx">title</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="nx">docid</span><span class="p">,</span>
                <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="nx">docrev</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span> <span class="o">:</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span>
                <span class="s2">&quot;TextNote&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;note&quot;</span> <span class="o">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span> <span class="o">:</span> <span class="nx">text</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span> <span class="o">:</span> <span class="nx">tags</span><span class="p">}}</span>
        <span class="p">};</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
        <span class="nx">doStoreDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span> <span class="c1">//braucht alte id und rev</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;editPage after store&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#editContent&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;shownote&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">changePage</span><span class="p">(</span><span class="s2">&quot;#editPage&quot;</span><span class="p">,</span> <span class="s2">&quot;slidedown&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With this we have completed the core of our CouchApp. We can create new notes which will be displayed, grouped by their assigned tags and edit them. All of this happens inside the CouchDB and your browser.</p>
<p>As usual, you should export the CouchApp directory tree to your CouchDB with the command <tt class="docutils literal"><span class="pre">enotes$</span> <span class="pre">couchapp</span> <span class="pre">push</span> <span class="pre">enotes</span></tt>. After that, access your CouchApp in your web browser at <a class="reference external" href="http://127.0.0.1:5984/enotes/_design/enotes/index.html">http://127.0.0.1:5984/enotes/_design/enotes/index.html</a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Program Logic</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#startup-code">StartUp Code</a><ul>
<li><a class="reference internal" href="#loader-js">loader.js</a></li>
<li><a class="reference internal" href="#logic-js">logic.js</a></li>
</ul>
</li>
<li><a class="reference internal" href="#action-code-evently">Action Code / Evently</a><ul>
<li><a class="reference internal" href="#addpage-event">addPage - Event</a></li>
<li><a class="reference internal" href="#save-notes">Save Notes</a></li>
<li><a class="reference internal" href="#review-the-document">Review the Document</a></li>
<li><a class="reference internal" href="#list-used-tags">List used Tags</a></li>
<li><a class="reference internal" href="#list-notes-from-tag">List Notes from Tag</a></li>
<li><a class="reference internal" href="#open-notes">Open Notes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="3-Interface.html"
                        title="previous chapter">Write the Interface</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="99-Expand.html"
                        title="next chapter">Extend our CouchApp</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/4-Logic.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="99-Expand.html" title="Extend our CouchApp"
             >next</a> |</li>
        <li class="right" >
          <a href="3-Interface.html" title="Write the Interface"
             >previous</a> |</li>
        <li><a href="index.html">Enotes CouchApp Tutorial v0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Markus Mayr.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>